name: Sync to Public Repository

on:
  push:
    branches: [ main, demo ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Clone public repository
      run: |
        git clone https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/akira-fujita/hr-talent-dashboard-public.git public-repo
      env:
        PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}

    - name: Sync files to public repository
      run: |
        # å…¬é–‹ç”¨ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        cd public-repo
        
        # ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆæ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
        rsync -av --exclude='.git' \
                  --exclude='.streamlit/secrets.toml' \
                  --exclude='venv' \
                  --exclude='__pycache__' \
                  --exclude='.DS_Store' \
                  --exclude='notion_import' \
                  ../ ./
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "Auto-sync from main repository
          
          Source commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push origin main
          echo "âœ… Successfully synced to public repository"
        else
          echo "â„¹ï¸ No changes to sync"
        fi

    - name: Create GitHub Release (on version tags)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ğŸš€ New release of HR Talent Dashboard
          
          **Changes**: 
          - Auto-synced from private repository
          - See main repository for detailed changelog
          
          **Demo**: https://akira-fujita-test-hr-dashboard-app-2rwmjj.streamlit.app
        draft: false
        prerelease: false